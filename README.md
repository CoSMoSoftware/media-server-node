# WebRTC Medooze Media Server for Node.js

[![Codacy Badge](https://api.codacy.com/project/badge/Grade/72346e5229bc4fd8af091312be091fdd)](https://www.codacy.com/app/murillo128/media-server-node?utm_source=github.com&utm_medium=referral&utm_content=medooze/media-server-node&utm_campaign=badger)

This media server will allow you to receive and send media streams from remote WebRTC peers and manage how you want to route them. 
You will be able to record any incoming stream into an mp4 file.
SVC layer selection and simulcast support.

## Install

    npm i --save medooze-media-server

## Usage

    const MediaServer = require('medooze-media-server');

## Example

```javascript
//Get the Medooze Media Server interface
const MediaServer = require("../index");

//Create UDP server endpoint
const endpoint = MediaServer.createEndpoint(ip);

//Create an DTLS ICE transport in that enpoint
const transport = endpoint.createTransport({
		dtls : offer.getMedias()[0].getDTLS(),
		ice  : offer.getMedias()[0].getICE() 
	});
	
//Set RTP remote properties
 transport.setRemoteProperties({
		audio : offer.getAudio(),
		video : offer.getVideo()
	});


//Get local DTLS and ICE info
const dtls = transport.getLocalDTLSInfo();
const ice  = transport.getLocalICEInfo();

//Get local candidte
const candidate = endpoint.getLocalCandidate();

//Create local SDP info
let answer = new SDPInfo();

//Set RTP local  properties
 transport.setLocalProperties({
		audio : answer.getAudio(),
		video : answer.getVideo()
	});
	

//Get remote audio m-line info 
let audioOffer = offer.getAudio();

//If we have audio
if (audioOffer!=null)
{
	//Create audio media
	let audio = new MediaInfo("audio", "audio");
	//Add ice and dtls info
	audio.setDTLS(dtls);
	audio.setICE(ice);
	audio.addCandidate(candidate);
	//Get codec type
	let opus = audioOffer.getCodec("opus");
	//Add opus codec
	audio.addCodec(opus);

	//Add audio extensions
	for (let extension of audioOffer.getExtensions().entries())
		//Add it
		audio.addExtension(extension[0], extension[1]);
	//Add it to answer
	answer.addMedia(audio);
}

//Get remote video m-line info 
let videoOffer = offer.getVideo();

//If offer had video
if (videoOffer!=null)
{
	//Create video media
	let  video = new MediaInfo("video", "video");
	//Add ice and dtls info
	video.setDTLS(dtls);
	video.setICE(ice);
	video.addCandidate(candidate);
	//Get codec types
	let vp9 = videoOffer.getCodec("vp9");
	let fec = videoOffer.getCodec("flexfec-03");
	//Add video codecs
	video.addCodec(vp9);
	if (fec!=null)
		video.addCodec(fec);
	//Limit incoming bitrate
	video.setBitrate(1024);

	//Add video extensions
	for (let extension of videoOffer.getExtensions().entries())
		//Add it
		video.addExtension(extension[0], extension[1]);

	//Add it to answer
	answer.addMedia(video);
}

//For each stream offered
for (let offered of offer.getStreams().values())
{
	//Create the remote stream into the transport
	const incomingStream = transport.createIncomingStream(offered);
	
	//Create new local stream
	const outgoingStream  = transport.createOutgoingStream({
		audio: true,
		video: true
	});

	//Get local stream info
	const info = outgoingStream.getStreamInfo();
	
	//Copy incoming data from the remote stream to the local one
	outgoingStream.attachTo(incomingStream);
	
	//Add local stream info it to the answer
	answer.addStream(info);
}
//Get answer SDP
const str = answer.toString();
```

## API

<!-- Generated by documentation.js. Update this documentation by updating the source code. -->

### Recorder

MP4 recorder that allows to record several streams/tracks on a single mp4 file

#### stop

Stop recording and close file. NOTE: File will be flsuh async,

Returns **[undefined](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/undefined)**  TODO: return promise when flush is ended

### createEndpoint

Create a new endpoint object

**Parameters**

-   `ip` **[String](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String)** External IP address of server, to be used when announcing the local ICE candidate

Returns **[Endpoint](#endpoint)** The new created endpoing

### createRecorder

Create a new MP4 recorder

**Parameters**

-   `filename` **[String](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String)** Path and filename of the recorded mp4 file

Returns **[Recorder](#recorder)** 

### OutgoingStreamTrack

Audio or Video track of a media stream sent to a remote peer

#### getId

Get track id as signaled on the SDP

#### getMedia

Get track media type

Returns **[String](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String)** "audio"|"video"

#### attachTo

Listen media from the incoming stream track and send it to the remote peer of the associated transport.

**Parameters**

-   `incomingStreamTrack` **[IncomingStreamTrack](#incomingstreamtrack)** The incoming stream to listen media for

#### detach

Stop listening for media

#### on

Add event listener

**Parameters**

-   `event` **[String](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String)** Event name
-   `listener` **[function](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/function)** Event listener

Returns **[IncomingStreamTrack](#incomingstreamtrack)** 

#### off

Remove event listener

**Parameters**

-   `event` **[String](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String)** Event name
-   `listener` **[function](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/function)** Event listener

Returns **[IncomingStreamTrack](#incomingstreamtrack)** 

#### stop

Removes the track from the outgoing stream and also detaches from any attached incoming track

### IncomingStreamTrack

Audio or Video track of a remote media stream

#### getId

Get track id as signaled on the SDP

#### getMedia

Get track media type

Returns **[String](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String)** "audio"|"video"

#### on

Add event listener

**Parameters**

-   `event` **[String](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String)** Event name
-   `listener` **[function](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/function)** Event listener

Returns **[IncomingStreamTrack](#incomingstreamtrack)** 

#### off

Remove event listener

**Parameters**

-   `event` **[String](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String)** Event name
-   `listener` **[function](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/function)** Event listener

Returns **[IncomingStreamTrack](#incomingstreamtrack)** 

#### stop

Removes the track from the incoming stream and also detaches any attached outgoing track or recorder

### IncomingStream

The incoming streams represent the recived media stream from a remote peer.

#### getId

The media stream id as announced on the SDP

Returns **[String](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String)** 

#### on

Add event listener

**Parameters**

-   `event` **[String](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String)** Event name
-   `listener` **[function](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/function)** Event listener

Returns **[IncomingStream](#incomingstream)** 

#### off

Remove event listener

**Parameters**

-   `event` **[String](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String)** Event name
-   `listener` **[function](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/function)** Event listener

Returns **[IncomingStream](#incomingstream)** 

#### getAudioTracks

Get an array of the media stream audio tracks

Returns **([Array](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array) | IncomingStreamTracks)** Array of tracks

#### getVideoTracks

Get an array of the media stream video tracks

Returns **([Array](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array) | IncomingStreamTracks)** Array of tracks

#### stop

Removes the media strem from the transport and also detaches from any attached incoming stream

### OutgoingStream

The incoming streams represent the media stream sent to a remote peer.

#### attachTo

Listen media from the incoming stream and send it to the remote peer of the associated transport.

**Parameters**

-   `incomingStream` **[IncomingStream](#incomingstream)** The incoming stream to listen media for

#### detach

Stop listening for media

#### getStreamInfo

Get the stream info object for signaling the ssrcs and stream info on the SDP to the remote peer

Returns **StreamInfo** The stream info object

#### getId

The media stream id as announced on the SDP

Returns **[String](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String)** 

#### on

Add event listener

**Parameters**

-   `event` **[String](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String)** Event name
-   `listener` **[function](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/function)** Event listener

Returns **[IncomingStream](#incomingstream)** 

#### off

Remove event listener

**Parameters**

-   `event` **[String](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String)** Event name
-   `listener` **[function](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/function)** Event listener

Returns **[OutgoingStream](#outgoingstream)** 

#### getAudioTracks

Get an array of the media stream audio tracks

Returns **([Array](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array) | OutgoingStreamTracks)** Array of tracks

#### getVideoTracks

Get an array of the media stream video tracks

Returns **([Array](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array) \| [OutgoingStreamTrack](#outgoingstreamtrack))** Array of tracks

### Endpoint

An endpoint represent an UDP server socket.
The endpoint will process STUN requests in order to be able to associate the remote ip:port with the registered transport and forward any further data comming from that transport.
Being a server it is ICE-lite.

#### createTransport

Create a new transport object and register it with the remote ICE username and password

**Parameters**

-   `remote` **[Object](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)** Remote ICE and DTLS properties
    -   `remote.ice` **[Object](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)** Remote ICE info, containing the username and password. Remote ICE candidates list is not really used at all.
    -   `remote.dtls` **[Object](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)** Remote DTLS info

Returns **[Transport](#transport)** New transport object

#### getLocalCandidate

Get local ICE candidate for this endpoint. It will be shared by all the transport associated to this endpoint.

Returns **CandidateInfo** 

#### stop

Stop the endpoint UDP server and terminate any associated transport

### Transport

A transport represent a connection between a local ICE candidate and a remote set of ICE candidates over a single DTLS session.
The transport object will internally allocate the ICE and DTLS information of the local side in order to singal it to the remote side and establish the connection.
Each transport has a set of incoming and outgoing streams that allow to send or receive RTP streams to the remote peer. 
You must create the incoming streams as signaled on the remote SDP as any incoming RTP with an unknown ssrc will be ignored. 
When you create an outgoing stream, the transport will allocate internally the ssrcs for the different RTP streams in order to avoid collision. You will be able to retrieve that information from the streams object in order to be able to announce them on the SDP sent to the remote side.
In order to decide how to route your streams you must attach the outgoing streams from one transport to the incoming streams of other (or same) transport.

#### setLocalProperties

Set local RTP properties

**Parameters**

-   `rtp` **[Object](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)** Object param containing media information for audio and video
    -   `rtp.audio` **MediaInfo** Audio media info
    -   `rtp.video` **MediaInfo** Video media info

#### setRemoteProperties

Set remote RTP properties

**Parameters**

-   `rtp` **[Object](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)** Object param containing media information for audio and video
    -   `rtp.audio` **MediaInfo** Audio media info
    -   `rtp.video` **MediaInfo** Video media info

#### on

Add event listener

**Parameters**

-   `event` **[String](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String)** Event name
-   `listeener` **[function](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/function)** Event listener

Returns **[Transport](#transport)** 

#### off

Remove event listener

**Parameters**

-   `event` **[String](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String)** Event name
-   `listener` **[function](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/function)** Event listener

Returns **[Transport](#transport)** 

#### getLocalDTLSInfo

Get transport local DTLS info

Returns **DTLSInfo** DTLS info object

#### getLocalICEInfo

Get transport local ICE info

Returns **ICEInfo** ICE info object

#### createOutgoingStream

Create new outgoing stream in this transport

**Parameters**

-   `params` **[Object](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)** 
    -   `params.audio` **boolen** Add audio track to the new stream
    -   `params.video` **boolen** Add video track to the new stream

Returns **[OutgoingStream](#outgoingstream)** The new outgoing stream

#### createIncomingStream

Create an incoming stream object from the media stream info objet

**Parameters**

-   `info` **StreamInfo** Contains the ids and ssrcs of the stream to be created

Returns **[IncomingStream](#incomingstream)** The newly created incoming stream object

#### publish

Create new outgoing stream and attach to the incoming stream

**Parameters**

-   `incomingStream` **[IncomingStream](#incomingstream)** the incoming stream to be published in this transport

Returns **[OutgoingStream](#outgoingstream)** The new outgoing stream

#### stop

Stop transport and all the associated incoming and outgoing streams

### IncomingStreamTrack#stopped

IncomingStreamTrack stopped event

### IncomingStream#stopped

IncomingStream stopped event

### OutgoingStreamTrack#stopped

OutgoingStreamTrack stopped event

### OutgoingStream#stopped

OutgoingStream stopped event

### Transport#stopped

Transport stopped event

## Author

Sergio Garcia Murillo

\#License
MIT
